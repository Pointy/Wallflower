<!DOCTYPE html>
<html>
  <head>
    <link rel='stylesheet' href='jqui/css/ui-lightness/jquery-ui-1.8.2.custom.css'/>
    <script src='http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
    <script src='jqui/js/jquery-ui-1.8.2.custom.min.js'></script>
    <script src='wallflower-0.1.js'></script>
    <script>
      //
      // Demo part 1: establish wallflower features for this page
      //
      // This section of code will establish the handlers for all the
      // unobtrusive features used on this page. Of course, if we were
      // really being unobtrusive this would be a separate file, but
      // it's here for convenience.
      //
      $.wallflower({
        "datepicker": {selector: 'input:text.datepicker'},
        "dialog": {
          selector: 'div.dialog',
          defaults: {
            buttons: {
              "Ok": function() {
                $(this).dialog('close');
              }
            },
            autoOpen: false
          }
        }
      });

      $.wallflower('load-marker', function(_) {
        $(this).text('loaded: ' + new Date());
      });

      $.wallflower({
        'textarea-maxlength': {
          defaults: { maxlength: 100 },
          selector: 'textarea',
          attribute: 'maxlength',
          evalAttr: false,
          handler: function(params) {
            var
              ta = $(this),
              ml = params.maxlength,
              counter = $('<span/>', {
                text: ml,
                className: 'textareaCounter',
                css: {opacity: 0}
              });

            ta.after(counter);

            function hex(n) {
              n = Math.max(0, Math.min(255, Math.floor(n)));
              var h = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'A', 'B', 'C', 'D', 'E', 'F'];
              return h[Math.floor(n / 16)] + h[n % 16];
            }

            ta.bind('click paste keyup', function(ev) {
              var
                adjust = ta.val().match(/[^\r]\n/g),
                alen = adjust ? adjust.length : 0,
                actual = ta.val().length + alen,
                ratio = Math.max(actual/ml);

              if (actual > ml) {
                var cur = ta.scrollTop();
                ta.val(ta.val().substring(0, ml - alen));
                ta.scrollTop(cur);
              }

              counter.css({
                'opacity': ratio < 0.5 ? 0 : ratio,
                'color': '#' + hex(64 + ratio * (255 - 64)) + '4040'
              }).text(Math.max(0, ml - actual));
            });
          }
        }
      });

      // Demo part 2: invoking wallflower at document.ready time

      $(function() {
        $('body').wallflower();

        $('#loader').click(function() {
          $('#loadable')
            .load('wallflower-fragment.html', function() {
              $(this).wallflower({datepicker: {maxDate: 7}});
            });
        });

        $('#launcher').live('click', function() {
          $('#dialog').dialog('open');
        });
      });

    </script>
    <style>
    </style>
  </head>
  <body>
    <input class='datepicker' data-wf='minDate: 0'><br>
    <button id='loader'>Click to load a fragment</button>
    <div id='loadable'></div>
  </body>
</html>
